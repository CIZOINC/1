Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      SourceSecurityGroupName: {"Fn::GetAtt" : ["AWSEBLoadBalancer" , "SourceSecurityGroup.GroupName"]}

files:
  /etc/nginx/conf.d/ssl.conf:
    content: |
      map $http_upgrade $connection_upgrade {
        default   "upgrade";
        ""        "";
      }
  
      server {
        listen         80;
        server_name    localhost;
  
        location = /status.html {
          proxy_pass          http://my_app;
          proxy_http_version  1.1;
  
          proxy_set_header    Connection          $connection_upgrade;
          proxy_set_header    Upgrade             $http_upgrade;
          proxy_set_header    Host                $host;
          proxy_set_header    X-Real-IP           $remote_addr;
          proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
          proxy_set_header    X-Forwarded-Host    $host;
          proxy_set_header    X-Forwarded-Server  $host;
        }
  
        location / {
          return        301 https://$host$request_uri;
        }
      }
  
      server {
        listen       443;
        server_name  localhost;
  
        ssl                  on;
        ssl_certificate      /etc/pki/tls/certs/server.crt;
        ssl_certificate_key  /etc/pki/tls/certs/server.key;
        
        ssl_session_timeout  5m;

        ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
        ssl_prefer_server_ciphers   on;
  
        location / {
          proxy_pass          http://my_app;
          proxy_http_version  1.1;
  
          proxy_set_header    Connection          $connection_upgrade;
          proxy_set_header    Upgrade             $http_upgrade;
          proxy_set_header    Host                $host;
          proxy_set_header    X-Real-IP           $remote_addr;
          proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
          proxy_set_header    X-Forwarded-Host    $host;
          proxy_set_header    X-Forwarded-Server  $host;
        }

        location /assets {
          alias /var/app/current/public/assets;
          gzip_static on;
          gzip on;
          expires max;
          add_header Cache-Control public;
        }

        location /public {
          alias /var/app/current/public;
          gzip_static on;
          gzip on;
          expires max;
          add_header Cache-Control public;
        }
      }
  
  /etc/pki/tls/certs/server.crt:
    content: |
      -----BEGIN CERTIFICATE-----
      MIIDBjCCAe4CCQCv24K3NWzpHzANBgkqhkiG9w0BAQUFADBFMQswCQYDVQQGEwJV
      UzETMBEGA1UECBMKQ2FsaWZvcm5pYTEhMB8GA1UEChMYSW50ZXJuZXQgV2lkZ2l0
      cyBQdHkgTHRkMB4XDTE1MTExNzAyMDIyMloXDTE2MTExNjAyMDIyMlowRTELMAkG
      A1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExITAfBgNVBAoTGEludGVybmV0
      IFdpZGdpdHMgUHR5IEx0ZDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
      ANEQfwvPYRDpS7m/ys97gt0wjQzQlM/7nU4J31l8MoM69BCqqpoxuiwcb/587McV
      Z5KgAIlylOeQGBa96ajOjLPifHgv2+KE9MUVe9FMx2gtWMiBW7JBZ/LjieYWKEGd
      Rcdu7rqtf8k9v6UsCLIeC1n5GPdnMkXxpjvJ7cShsiH/tSz9ZGq+QZjLF3KG7U+V
      9hfvfLAPcTuwib1N/HvLFj6D+Qqjy8EoLbvecRHmkzg1+kIbq4s8pDeQm2gokNG7
      FeOYe29k1HxWO9S9H4gKdKY+l7b/AVcThmVMB4kAVGLG+zvdPzJTM3KoJiyCDQ0s
      DECuFBL0MLm0hEeQCDOdzkUCAwEAATANBgkqhkiG9w0BAQUFAAOCAQEAnhTsy/lx
      zR1RvRidEAprisUP/DY4zxuRmPD4B25w7pdeH0n4f+oqP4AM3k81EzPOuJBondkd
      h5pdQFmR3sDOidgG71QbGFTKJyQRkxs61SwE+dgtpHO+ZsqKctTotkF0/hw+w9n4
      mAMm/7DHrwEs7Z/yNQMRY8i+TL4TGWiN6xk2Z8Ofx1b92eKMtkU5GdGxJmcX6Yei
      TT0BaGiGOJvUodgPZxW2zJ98KvHd0lTBFdWyR6YM3g8GhyQs+bRR6XeIXrvS4m2H
      RzfPv349xzCAw3TuGv1tVaHU8oMZZeoqZ772cCis9XHs4KllD7ouhhhNu8bCKfcl
      3T1KjebFESPl0g==
      -----END CERTIFICATE-----

  
  
  /etc/pki/tls/certs/server.key:
    content: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpQIBAAKCAQEA0RB/C89hEOlLub/Kz3uC3TCNDNCUz/udTgnfWXwygzr0EKqq
      mjG6LBxv/nzsxxVnkqAAiXKU55AYFr3pqM6Ms+J8eC/b4oT0xRV70UzHaC1YyIFb
      skFn8uOJ5hYoQZ1Fx27uuq1/yT2/pSwIsh4LWfkY92cyRfGmO8ntxKGyIf+1LP1k
      ar5BmMsXcobtT5X2F+98sA9xO7CJvU38e8sWPoP5CqPLwSgtu95xEeaTODX6Qhur
      izykN5CbaCiQ0bsV45h7b2TUfFY71L0fiAp0pj6Xtv8BVxOGZUwHiQBUYsb7O90/
      MlMzcqgmLIINDSwMQK4UEvQwubSER5AIM53ORQIDAQABAoIBAARH8DIPtw8fl9tf
      4AlLoCxjWCARDVsM7fWxIg+1CVvCk0jcFc4+gm9wzaJKcJbLC2nnONuXqxDq1HNy
      xBwezqbIVoAnirsiudhnTjfE+LhbZVwFuhj2WeiRXDuH7J8bV1h0HxNXhixaxVfe
      hPcQwm6/ORGn3VGtVxgWVHYYUYt8pYF06lPIpHO1uzLxO76hX3iCn25HSaypjH1/
      ETMyQKtt0eqvZADERpNW9Ha5Fb0XWrCbTVquTaIROsc4OMQeoL5RXicGK+ya/LYT
      P6FGr+8HRx8Cv0yKkwuOyEyGbVGv7BQLxET7QtE19geN0FGtZn+uqUTsIKVrm2Gg
      bsTZ4AECgYEA6ebzKt0zp99ga0NCYv997lTMP6TynHobGh79u1CmrydHgHCuSWpp
      3CipdFGIoiPveXXrkEnCWsvvkTJ+ytKalvzZuqX8WcR7KJNIUClfoWNDcTLO1QBb
      0D0jmSmEHBhiOjXuEFMX8dEWVF5V2h21udhzG+JDRrL9cOxR4tcmWkUCgYEA5NDV
      PBcVz3OQRQu0MdOBT4KklcQDRzjEJKQe59exlzkZHVJdiGnEKru82JGGrSKQj02G
      VmUGPqrL/Yik0P7ca6UaOmq6tPFKnATNYQKpEYDwDs6cFZVPoqyUDBKpRNvlwKXS
      IJzvwPgGtapW9BTnmYt9jdNVbn/9gP+2oX3q5AECgYEAgOQlR4+RcYZkSXdM0+Ta
      bkUIMGIi1xtqZ+CADYKJ96b7fcmaIRaksw8tIc30LvUCd7oFTwN2ODZ9E1PyDq4z
      RdSb3oCtKIJfI6LVjGbgLbzXYz+OPk3uSjgGr9Xy2NCPAGjLgO9pGHYRifhZ8tHA
      XGLsO4dZb1Ie2uU+0nOgzMkCgYEAiMErgJOHjIpUIoAhPVpcwamiNoSFNQ7/Y6rX
      cddfI7OTiAvPLRWRkbzM3F71sAqlfZBnBsGwXsnzy17cqrB4CroNl/ZsCnLgFall
      GmLdq0F1uFPRw7COfPpKLYEFu8r1YRN6J9XEEX/req4I9C5+US2mZ5p0R+ulFnE+
      tPwt5AECgYEApz1wAGTkLKWwv17h054N0K5duoi/AnUblMcE7QmcREmk9j6CSy7B
      C0L0Zs5NA/8cvESxBl7LmfhA3UiMrOvGIIFShI4DuJZE2YluYiNaa9QnXHReArSL
      +HwlC69YYpTxfFeVahJ6IRXW+gKZaKj/vT90mYnIQWK7Tom8aUHlo18=
      -----END RSA PRIVATE KEY-----
  
container_commands:
  01restart_nginx:
    command: "service nginx restart"